#!/bin/sh -x
#
# cdtool - The behind-the-scenes magic glue that happens before a CD is made
#
# Michael Jennings <mej@eterm.org>
# 21 July 2000
#
# $Id: bootable-cdtool,v 1.6 2001/12/20 22:33:18 mej Exp $
#

umask 022

PATH=/bin:/usr/bin:/sbin:/usr/sbin

trap 'exit -1' 1 2 15

if [ "x$1" = "x-i" ]; then
    UPD=1
    shift
else
    UPD=0
fi

if [ "x$MEZZANINE_BUILDDIR" != "x" ]; then
    BUILDDIR=$MEZZANINE_BUILDDIR
else
    BUILDDIR=$PWD/build.mezz
fi

V_VER=`cut -d' ' -f2 /etc/vermillion`
RH_VER=`cut -d' ' -f5 /etc/redhat-release`

PKGLIST=$HOME/hjl_distro_stuff/base-${RH_VER}.list
POST_FILES=$HOME/cvs/jc-cd/post
IMAGE=/os/jc-cd
NET=vermillion-${V_VER}-net
IMGTOOL=imgtool
MEDIATOOL=mediatool

if [ $UPD -eq 1 ]; then
    $IMGTOOL -i $IMAGE -fl $PKGLIST -D $BUILDDIR/$NET/RedHat/RPMS:$HOME:$HOME/pkgs
fi

cd $IMAGE
find bin usr etc lib boot sbin \( -type d -o -type f \) -perm -0002 -xdev -exec chmod o-w {} \;

KERNEL_VER=`ls -1 boot/vmlinuz-*netboot | sed 's!boot/vmlinuz-!!'`

test -d boot && mv boot isolinux && ln -s isolinux boot
cp -a /usr/lib/syslinux/isolinux.bin $IMAGE/boot/
test -d root && mv root home/ && ln -s home/root root
mkdir -p -m 755 var/sys var/hd
touch var/sys/kernel.h && rm -f boot/kernel.h && ln -s /var/sys/kernel.h boot/kernel.h
rm -f boot/System.map
ln -sf System.map-${KERNEL_VER} boot/System.map
rm -f lib/modules/*/modules.dep
for i in lib/modules/*netboot ; do
    chroot $IMAGE /sbin/depmod -a -F /boot/System.map-${KERNEL_VER} ${KERNEL_VER}
done
mv -f lib/modules/${KERNEL_VER}/modules.dep var/sys/
for i in lib/modules/* ; do
    test -d $i && ln -sf /var/sys/modules.dep $i/modules.dep
done
rm -f etc/X11/X && ln -sf /usr/X11R6/bin/XFree86 etc/X11/X
for i in nfs nfslock ; do
    chroot $IMAGE /sbin/chkconfig --del $i
done
chroot $IMAGE /usr/sbin/netconfig --bootproto=dhcp -d eth0 --hostname=localhost --domain=localdomain
test -x usr/lib/ICAClient/npica.so && install -m 755 usr/lib/ICAClient/npica.so usr/lib/netscape/plugins/
for i in usr/lib/netscape/plugins/* ; do
    rm -f usr/lib/mozilla/plugins/`basename $i` && cp -a /$i usr/lib/mozilla/plugins/`basename $i`
done
for i in usr/X11R6/lib/X11/fonts/{misc,Type1,Speedo,75dpi,100dpi} usr/share/fonts/*/T* \
         usr/share/AbiSuite/fonts usr/X11R6/lib/X11/fonts/latin2/{Type1,100dpi} \
         usr/share/fonts/ISO8859-[79]/{misc,Type1,75dpi,100dpi} usr/share/fonts/KOI8-R/100dpi ; do
    test -d $i && chroot $IMAGE /usr/X11R6/bin/mkfontdir /$i
done
(cd $POST_FILES ; tar --exclude .cvsignore --exclude CVS --exclude ChangeLog -cf - .) | (cd $IMAGE ; tar -xf -)
mv usr/lib/security/*.so lib/security/

tar -zcf boot/etc.tgz etc

tar -zcf boot/var.tgz var

tar -zcf boot/home.tgz home

rm -rf tmp
ln -s /var/tmp tmp

cd $IMAGE/..
$MEDIATOOL -i jc-cd.iso -D $IMAGE -I isolinux
